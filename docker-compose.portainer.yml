# Docker Compose for Portainer deployment with GHCR images
#
# Usage with Portainer:
#   1. Create a new Stack
#   2. Use "Repository" method with this repo
#   3. Set compose file to: docker-compose.portainer.yml
#   4. Add environment variables (see below)
#
# Required environment variables:
#   - DB_PASSWORD: PostgreSQL password
#   - SECRET_KEY: Django secret key
#   - MINIO_ACCESS_KEY: MinIO access key
#   - MINIO_SECRET_KEY: MinIO secret key
#   - FIELD_ENCRYPTION_KEYS: 64-char hex encryption key
#   - ALLOWED_HOSTS: Your domain (e.g., lifegraph.example.com)
#   - CSRF_TRUSTED_ORIGINS: https://lifegraph.example.com
#
# Optional:
#   - OPENAI_API_KEY: For AI features
#   - MFA_REQUIRED: true/false

services:
  # PostgreSQL Database
  db:
    image: postgres:16-alpine
    restart: always
    environment:
      POSTGRES_DB: lifegraph
      POSTGRES_USER: lifegraph
      POSTGRES_PASSWORD: ${DB_PASSWORD:?DB_PASSWORD required}
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U lifegraph"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Redis for Celery and Cache
  redis:
    image: redis:7-alpine
    restart: always
    command: redis-server --appendonly yes --maxmemory 128mb --maxmemory-policy allkeys-lru
    volumes:
      - redis_data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  # MinIO Object Storage
  minio:
    image: minio/minio
    restart: always
    command: server /data --console-address ":9001"
    environment:
      MINIO_ROOT_USER: ${MINIO_ACCESS_KEY:?MINIO_ACCESS_KEY required}
      MINIO_ROOT_PASSWORD: ${MINIO_SECRET_KEY:?MINIO_SECRET_KEY required}
    volumes:
      - minio_data:/data
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]
      interval: 30s
      timeout: 20s
      retries: 3

  # MinIO bucket initialization
  minio-init:
    image: minio/mc
    depends_on:
      minio:
        condition: service_healthy
    environment:
      MINIO_ACCESS_KEY: ${MINIO_ACCESS_KEY}
      MINIO_SECRET_KEY: ${MINIO_SECRET_KEY}
    entrypoint: >
      /bin/sh -c "
      mc alias set myminio http://minio:9000 $${MINIO_ACCESS_KEY} $${MINIO_SECRET_KEY};
      mc mb --ignore-existing myminio/lifegraph;
      mc anonymous set none myminio/lifegraph;
      exit 0;
      "

  # Django Backend - GHCR Image
  backend:
    image: ghcr.io/ankirama/lifegraph-backend:latest
    restart: always
    environment:
      - DJANGO_SETTINGS_MODULE=lifegraph.settings.production
      - DEBUG=False
      - SECRET_KEY=${SECRET_KEY:?SECRET_KEY required}
      - DATABASE_URL=postgresql://lifegraph:${DB_PASSWORD}@db:5432/lifegraph
      - REDIS_URL=redis://redis:6379/0
      - ALLOWED_HOSTS=${ALLOWED_HOSTS:?ALLOWED_HOSTS required}
      - CORS_ALLOWED_ORIGINS=${CORS_ALLOWED_ORIGINS:-}
      - CSRF_TRUSTED_ORIGINS=${CSRF_TRUSTED_ORIGINS:-}
      - SECURE_SSL_REDIRECT=false
      - FIELD_ENCRYPTION_KEYS=${FIELD_ENCRYPTION_KEYS:?FIELD_ENCRYPTION_KEYS required}
      - OPENAI_API_KEY=${OPENAI_API_KEY:-}
      - MFA_REQUIRED=${MFA_REQUIRED:-false}
      - LINKEDIN_ENABLED=${LINKEDIN_ENABLED:-false}
      - LINKEDIN_EMAIL=${LINKEDIN_EMAIL:-}
      - LINKEDIN_PASSWORD=${LINKEDIN_PASSWORD:-}
      - MINIO_ENDPOINT=http://minio:9000
      - MINIO_ACCESS_KEY=${MINIO_ACCESS_KEY}
      - MINIO_SECRET_KEY=${MINIO_SECRET_KEY}
      - MINIO_BUCKET_NAME=lifegraph
    volumes:
      - backend_static:/app/staticfiles
      - backend_media:/app/media
    expose:
      - "8000"
    depends_on:
      db:
        condition: service_healthy
      redis:
        condition: service_healthy
      minio:
        condition: service_healthy
    command: >
      sh -c "python manage.py migrate --noinput &&
             python manage.py collectstatic --noinput &&
             gunicorn lifegraph.wsgi:application --bind 0.0.0.0:8000 --workers 2 --threads 2"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/api/v1/health/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  # Celery Worker
  worker:
    image: ghcr.io/ankirama/lifegraph-backend:latest
    restart: always
    environment:
      - DJANGO_SETTINGS_MODULE=lifegraph.settings.production
      - DEBUG=False
      - SECRET_KEY=${SECRET_KEY}
      - DATABASE_URL=postgresql://lifegraph:${DB_PASSWORD}@db:5432/lifegraph
      - REDIS_URL=redis://redis:6379/0
      - FIELD_ENCRYPTION_KEYS=${FIELD_ENCRYPTION_KEYS}
      - OPENAI_API_KEY=${OPENAI_API_KEY:-}
      - LINKEDIN_ENABLED=${LINKEDIN_ENABLED:-false}
      - LINKEDIN_EMAIL=${LINKEDIN_EMAIL:-}
      - LINKEDIN_PASSWORD=${LINKEDIN_PASSWORD:-}
      - MINIO_ENDPOINT=http://minio:9000
      - MINIO_ACCESS_KEY=${MINIO_ACCESS_KEY}
      - MINIO_SECRET_KEY=${MINIO_SECRET_KEY}
      - MINIO_BUCKET_NAME=lifegraph
    depends_on:
      db:
        condition: service_healthy
      redis:
        condition: service_healthy
    command: celery -A lifegraph worker -l INFO --concurrency=2

  # Celery Beat (Scheduler)
  scheduler:
    image: ghcr.io/ankirama/lifegraph-backend:latest
    restart: always
    environment:
      - DJANGO_SETTINGS_MODULE=lifegraph.settings.production
      - DEBUG=False
      - SECRET_KEY=${SECRET_KEY}
      - DATABASE_URL=postgresql://lifegraph:${DB_PASSWORD}@db:5432/lifegraph
      - REDIS_URL=redis://redis:6379/0
      - FIELD_ENCRYPTION_KEYS=${FIELD_ENCRYPTION_KEYS}
    depends_on:
      db:
        condition: service_healthy
      redis:
        condition: service_healthy
    command: celery -A lifegraph beat -l INFO

  # React Frontend - GHCR Image
  frontend:
    image: ghcr.io/ankirama/lifegraph-frontend:latest
    restart: always
    expose:
      - "80"
    depends_on:
      - backend
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:80/"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Nginx Reverse Proxy (combines frontend + backend)
  nginx:
    image: nginx:alpine
    restart: always
    ports:
      - "8080:80"
    volumes:
      - backend_static:/var/www/static:ro
    depends_on:
      - backend
      - frontend
    command: |
      sh -c "cat > /etc/nginx/conf.d/default.conf << 'NGINX'
      upstream backend {
          server backend:8000;
      }
      upstream frontend {
          server frontend:80;
      }
      server {
          listen 80;
          server_name _;
          client_max_body_size 25M;

          # Static files from Django
          location /static/ {
              alias /var/www/static/;
          }

          # API requests to Django
          location /api/ {
              proxy_pass http://backend;
              proxy_set_header Host $$host;
              proxy_set_header X-Real-IP $$remote_addr;
              proxy_set_header X-Forwarded-For $$proxy_add_x_forwarded_for;
              proxy_set_header X-Forwarded-Proto $$scheme;
          }

          # Admin panel
          location /admin/ {
              proxy_pass http://backend;
              proxy_set_header Host $$host;
              proxy_set_header X-Real-IP $$remote_addr;
              proxy_set_header X-Forwarded-For $$proxy_add_x_forwarded_for;
              proxy_set_header X-Forwarded-Proto $$scheme;
          }

          # Auth endpoints (allauth)
          location /accounts/ {
              proxy_pass http://backend;
              proxy_set_header Host $$host;
              proxy_set_header X-Real-IP $$remote_addr;
              proxy_set_header X-Forwarded-For $$proxy_add_x_forwarded_for;
              proxy_set_header X-Forwarded-Proto $$scheme;
          }

          # Health check
          location /health/ {
              proxy_pass http://backend/api/v1/health/;
          }

          # Frontend (everything else)
          location / {
              proxy_pass http://frontend;
              proxy_set_header Host $$host;
              proxy_set_header X-Real-IP $$remote_addr;
          }
      }
      NGINX
      nginx -g 'daemon off;'"

  # Backup Service
  backup:
    image: ghcr.io/ankirama/lifegraph-backup:latest
    restart: always
    environment:
      - POSTGRES_HOST=db
      - POSTGRES_PORT=5432
      - POSTGRES_DB=lifegraph
      - POSTGRES_USER=lifegraph
      - PGPASSWORD=${DB_PASSWORD}
      - MINIO_ENDPOINT=http://minio:9000
      - MINIO_ACCESS_KEY=${MINIO_ACCESS_KEY}
      - MINIO_SECRET_KEY=${MINIO_SECRET_KEY}
      - MINIO_BUCKET=lifegraph
      - BACKUP_DIR=/backups
    volumes:
      - backup_data:/backups
    depends_on:
      db:
        condition: service_healthy
      minio:
        condition: service_healthy

volumes:
  postgres_data:
  redis_data:
  minio_data:
  backend_static:
  backend_media:
  backup_data:
